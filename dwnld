import requests
import pandas as pd
from datetime import datetime

# === CONFIG ===
API_TOKEN = "hdjdjdjdjdjd"
BASE_URL = "https://demo.defectdojo.org"
LIMIT = 1000

HEADERS = {
    "Authorization": f"Token {API_TOKEN}",
    "Content-Type": "application/json"
}

def fetch_engagements(session, start_date, end_date):
    """Fetch all engagements created between two dates."""
    url = f"{BASE_URL}/api/v2/engagements/"
    params = {
        "created_after": f"{start_date}T00:00:00",
        "created_before": f"{end_date}T23:59:59",
        "limit": LIMIT,
        "offset": 0
    }
    print(f"[INFO] Fetching engagements {start_date} to {end_date}...")
    r = session.get(url, params=params)
    if r.status_code != 200:
        raise RuntimeError(f"Failed to fetch engagements: {r.status_code} {r.text}")
    return r.json().get("results", [])

def fetch_jira_count(session, engagement_id):
    """Fetch Jira count for an engagement."""
    url = f"{BASE_URL}/api/v2/tests/"
    params = {
        "engagement": engagement_id,
        "tags": "patch_jira",
        "limit": LIMIT,
        "offset": 0
    }
    r = session.get(url, params=params)
    if r.status_code != 200:
        print(f"[WARN] Could not fetch Jira count for engagement {engagement_id}")
        return 0
    return len(r.json().get("results", []))

def process_engagements(session, engagements):
    """Convert engagements JSON into structured rows."""
    rows = []
    for e in engagements:
        created_date = e.get("created", "")[:10]  # YYYY-MM-DD
        updated_date = e.get("updated", "")[:10]  # YYYY-MM-DD

        # Review Status logic (commit_hash field if exists)
        commit_hash = e.get("commit_hash", "").strip() if "commit_hash" in e else ""
        if commit_hash in ("", "Not Started"):
            review_status = "Approved"
        else:
            review_status = commit_hash

        # Timeline in days
        try:
            d_created = datetime.strptime(created_date, "%Y-%m-%d")
            d_updated = datetime.strptime(updated_date, "%Y-%m-%d")
            timeline_days = (d_updated - d_created).days
        except:
            timeline_days = ""

        # Jira count
        engagement_id = e.get("id", None)
        jira_count = fetch_jira_count(session, engagement_id) if engagement_id else 0

        rows.append({
            "Patch": e.get("name", ""),
            "Creation Date": created_date,
            "Status": "Completed",
            "Review Status": review_status,
            "Completion Date": updated_date,
            "Timeline (days)": timeline_days,
            "IR": e.get("version", ""),
            "No. of Jiras": jira_count
        })
    return rows

def main():
    date1 = input("Enter start date (YYYY-MM-DD): ").strip()
    date2 = input("Enter end date (YYYY-MM-DD): ").strip()

    session = requests.Session()
    session.headers.update(HEADERS)

    engagements = fetch_engagements(session, date1, date2)
    print(f"[INFO] Total engagements fetched: {len(engagements)}")

    rows = process_engagements(session, engagements)

    df = pd.DataFrame(rows)
    output_file = f"patches_completed_{date1}-{date2}.xlsx"
    df.to_excel(output_file, index=False)

    print(f"[SUCCESS] Data saved to {output_file}")

if __name__ == "__main__":
    main()