import pandas as pd
import requests

# Load your Excel file
df = pd.read_excel("engagement_lead_update.xlsx")  # Columns: id, lead

# DefectDojo API Token and Base URL
TOKEN = "dhjdjjd"
BASE_URL = "https://demo.defectdojo.org/api/v2"
HEADERS = {
    "Authorization": f"Token {TOKEN}",
    "Content-Type": "application/json"
}

for index, row in df.iterrows():
    engagement_id = row["id"]
    new_lead_id = row["lead"]
    
    # Step 1: Get existing engagement details
    response = requests.get(f"{BASE_URL}/engagements/{engagement_id}/", headers=HEADERS)
    
    if response.status_code != 200:
        print(f"Failed to fetch engagement {engagement_id}: {response.text}")
        continue
    
    engagement = response.json()
    
    # Step 2: Update lead only, keep others same
    update_payload = {
        "id": engagement_id,
        "name": engagement["name"],
        "target_start": engagement["target_start"],
        "target_end": engagement["target_end"],
        "lead": new_lead_id,
        "product": engagement["product"]
    }
    
    # Step 3: PUT request to update the engagement
    put_response = requests.put(f"{BASE_URL}/engagements/{engagement_id}/", headers=HEADERS, json=update_payload)
    
    if put_response.status_code == 200:
        print(f"Updated lead for engagement {engagement_id} successfully.")
    else:
        print(f"Failed to update engagement {engagement_id}: {put_response.text}")