#!/usr/bin/env python3
import tkinter as tk
import customtkinter as ctk
import pandas as pd
import json
import requests
import os
from tkinter import filedialog, messagebox
import threading
from datetime import datetime

# Set appearance mode and default theme
ctk.set_appearance_mode("System")
ctk.set_default_color_theme("blue")

class ProductManagerApp:
    def __init__(self, root):
        self.root = root
        self.root.title("Product Manager")
        self.root.geometry("600x700")  # Adjusted height for compact layout
        self.root.minsize(500, 600)  # Minimum size for responsiveness
        self.script_dir = os.path.dirname(os.path.abspath(__file__))
        self.token_file = os.path.join(self.script_dir, "token.json")
        self.token = self.load_token()

        # Main container frame
        self.main_frame = ctk.CTkFrame(self.root, fg_color="transparent")
        self.main_frame.grid(row=0, column=0, padx=20, pady=20, sticky="nsew")
        self.root.grid_rowconfigure(0, weight=1)
        self.root.grid_columnconfigure(0, weight=1)

        # Tabview
        self.tabview = ctk.CTkTabview(self.main_frame)
        self.tabview.grid(row=0, column=0, sticky="nsew")
        self.main_frame.grid_rowconfigure(0, weight=1)
        self.main_frame.grid_columnconfigure(0, weight=1)

        # Product tab
        self.product_tab = self.tabview.add("Product")

        # Token Frame
        self.token_frame = ctk.CTkFrame(self.product_tab)
        self.token_frame.grid(row=0, column=0, padx=10, pady=10, sticky="ew")
        self.token_frame.grid_columnconfigure(1, weight=1)

        self.token_label = ctk.CTkLabel(self.token_frame, text="API Token:", font=("Arial", 12))
        self.token_label.grid(row=0, column=0, padx=5, pady=5, sticky="w")
        self.token_entry = ctk.CTkEntry(self.token_frame, show="*", width=200)
        self.token_entry.grid(row=0, column=1, padx=5, pady=5, sticky="ew")
        self.token_status = ctk.CTkLabel(self.token_frame, text="", font=("Arial", 10))
        self.token_status.grid(row=1, column=0, columnspan=2, padx=5, pady=2)
        ctk.CTkButton(self.token_frame, text="Save Token", command=self.save_token, width=100).grid(row=0, column=2, padx=5, pady=5)
        self.update_token_status()

        # Product Input Frame
        self.input_frame = ctk.CTkFrame(self.product_tab)
        self.input_frame.grid(row=1, column=0, padx=10, pady=10, sticky="ew")
        self.input_frame.grid_columnconfigure(1, weight=1)

        self.id_label = ctk.CTkLabel(self.input_frame, text="Product ID (Optional):", font=("Arial", 12))
        self.id_label.grid(row=0, column=0, padx=5, pady=5, sticky="w")
        self.id_entry = ctk.CTkEntry(self.input_frame, width=200)
        self.id_entry.grid(row=0, column=1, padx=5, pady=5, sticky="ew")

        self.name_label = ctk.CTkLabel(self.input_frame, text="Product Name:", font=("Arial", 12))
        self.name_label.grid(row=1, column=0, padx=5, pady=5, sticky="w")
        self.name_entry = ctk.CTkTextbox(self.input_frame, height=50, width=200, font=("Arial", 12))
        self.name_entry.grid(row=1, column=1, padx=5, pady=5, sticky="ew")

        self.desc_label = ctk.CTkLabel(self.input_frame, text="Description:", font=("Arial", 12))
        self.desc_label.grid(row=2, column=0, padx=5, pady=5, sticky="w")
        self.desc_entry = ctk.CTkTextbox(self.input_frame, height=80, width=200, font=("Arial", 12))
        self.desc_entry.grid(row=2, column=1, padx=5, pady=5, sticky="ew")

        self.prod_type_label = ctk.CTkLabel(self.input_frame, text="Product Type (Number):", font=("Arial", 12))
        self.prod_type_label.grid(row=3, column=0, padx=5, pady=5, sticky="w")
        self.prod_type_entry = ctk.CTkEntry(self.input_frame, width=200)
        self.prod_type_entry.grid(row=3, column=1, padx=5, pady=5, sticky="ew")

        self.sla_label = ctk.CTkLabel(self.input_frame, text="SLA Configuration (Number):", font=("Arial", 12))
        self.sla_label.grid(row=4, column=0, padx=5, pady=5, sticky="w")
        self.sla_entry = ctk.CTkEntry(self.input_frame, width=200)
        self.sla_entry.grid(row=4, column=1, padx=5, pady=5, sticky="ew")

        # Button Frame
        self.button_frame = ctk.CTkFrame(self.product_tab)
        self.button_frame.grid(row=2, column=0, padx=10, pady=10, sticky="ew")
        ctk.CTkButton(self.button_frame, text="Submit Product", command=self.submit_product, width=120).grid(row=0, column=0, padx=5, pady=5)
        ctk.CTkButton(self.button_frame, text="Import Excel", command=self.import_excel, width=120).grid(row=0, column=1, padx=5, pady=5)
        ctk.CTkButton(self.button_frame, text="Download Template", command=self.download_template, width=120).grid(row=0, column=2, padx=5, pady=5)

        # Progress Label
        self.progress_label = ctk.CTkLabel(self.product_tab, text="", font=("Arial", 12))
        self.progress_label.grid(row=3, column=0, padx=10, pady=5)

        # GUI Console
        self.console_frame = ctk.CTkFrame(self.product_tab)
        self.console_frame.grid(row=4, column=0, padx=10, pady=10, sticky="nsew")
        self.product_tab.grid_rowconfigure(4, weight=1)
        ctk.CTkLabel(self.console_frame, text="Console Output:", font=("Arial", 12)).grid(row=0, column=0, padx=5, pady=5, sticky="w")
        self.console = ctk.CTkTextbox(self.console_frame, height=100, state="disabled", font=("Arial", 10))
        self.console.grid(row=1, column=0, padx=5, pady=5, sticky="nsew")
        self.console_frame.grid_rowconfigure(1, weight=1)
        self.console_frame.grid_columnconfigure(0, weight=1)

    def log_to_console(self, message):
        """Log messages to the GUI console with timestamp."""
        self.console.configure(state="normal")
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        self.console.insert(tk.END, f"[{timestamp}] {message}\n")
        self.console.see(tk.END)
        self.console.configure(state="disabled")

    def load_token(self):
        """Load token from token.json in the script's directory."""
        try:
            if os.path.exists(self.token_file):
                with open(self.token_file, "r") as f:
                    return json.load(f).get("token", "")
        except Exception as e:
            self.log_to_console(f"Error loading token from {self.token_file}: {e}")
        return ""

    def save_token(self):
        """Save token to token.json in the script's directory and update status."""
        token = self.token_entry.get()
        try:
            with open(self.token_file, "w") as f:
                json.dump({"token": token}, f)
            self.token = token
            self.update_token_status()
            messagebox.showinfo("Success", "Token saved successfully!")
            self.log_to_console("Token saved successfully")
        except Exception as e:
            self.log_to_console(f"Error saving token to {self.token_file}: {e}")
            messagebox.showerror("Error", f"Failed to save token: {e}")

    def update_token_status(self):
        """Update token status label color and text."""
        if self.token:
            self.token_status.configure(text="Token Present", text_color="green")
        else:
            self.token_status.configure(text="No Token", text_color="red")

    def validate_number(self, value):
        """Validate if input is a number."""
        return value.isdigit() or value == ""

    def submit_product(self):
        """Submit product data to DefectDojo API (POST or PUT)."""
        if not self.token:
            messagebox.showerror("Error", "Please save a valid API token.")
            self.log_to_console("Error: No API token provided")
            return

        prod_type = self.prod_type_entry.get()
        sla_config = self.sla_entry.get()
        product_id = self.id_entry.get()

        if not self.validate_number(prod_type) or not self.validate_number(sla_config):
            messagebox.showerror("Error", "Product Type and SLA Configuration must be numbers.")
            self.log_to_console("Error: Product Type and SLA Configuration must be numbers")
            return

        data = {
            "name": self.name_entry.get("1.0", tk.END).strip(),
            "description": self.desc_entry.get("1.0", tk.END).strip(),
            "prod_type": int(prod_type) if prod_type else None,
            "sla_configuration": int(sla_config) if sla_config else None,
            "business_criticality": "medium",
            "platform": "web",
            "lifecycle": "active"
        }

        self.progress_label.configure(text="Submitting...")
        self.log_to_console("Submitting product data...")
        threading.Thread(target=self.post_or_put_to_api, args=(data, product_id), daemon=True).start()

    def post_or_put_to_api(self, data, product_id):
        """Post or Put data to DefectDojo API."""
        headers = {
            "Authorization": f"Token {self.token}",
            "Content-Type": "application/json"
        }
        base_url = "https://demo.defectdojo.org/api/v2/products"
        url = f"{base_url}/{product_id}/" if product_id else base_url
        method = "PUT" if product_id else "POST"

        try:
            if method == "POST":
                response = requests.post(url, headers=headers, json=data)
            else:
                response = requests.put(url, headers=headers, json=data)
            response.raise_for_status()
            self.progress_label.configure(text="Submission Successful!", text_color="green")
            self.log_to_console(f"{method} successful: {response.json()}")
        except requests.RequestException as e:
            self.progress_label.configure(text=f"Submission Failed: {e}", text_color="red")
            self.log_to_console(f"API Error ({method}): {e}")
            if response.status_code == 500:
                self.log_to_console("Server returned 500 Internal Server Error. Check payload or server status.")
        finally:
            self.root.after(3000, lambda: self.progress_label.configure(text=""))

    def import_excel(self):
        """Import product data from an Excel file."""
        file_path = filedialog.askopenfilename(filetypes=[("Excel files", "*.xlsx *.xls")])
        if not file_path:
            return

        self.progress_label.configure(text="Importing...")
        self.log_to_console(f"Importing Excel file: {file_path}")
        try:
            df = pd.read_excel(file_path)
            required_columns = ["name", "description", "prod_type", "sla_configuration"]
            optional_columns = ["id", "business_criticality", "platform", "lifecycle"]
            if not all(col in df.columns for col in required_columns):
                messagebox.showerror("Error", "Excel file must contain columns: name, description, prod_type, sla_configuration")
                self.log_to_console("Error: Missing required columns in Excel file")
                self.progress_label.configure(text="")
                return

            for _, row in df.iterrows():
                if not self.validate_number(str(row["prod_type"])) or not self.validate_number(str(row["sla_configuration"])):
                    messagebox.showerror("Error", "Product Type and SLA Configuration must be numbers.")
                    self.log_to_console("Error: Product Type and SLA Configuration must be numbers in Excel")
                    self.progress_label.configure(text="")
                    return

                data = {
                    "name": str(row["name"]),
                    "description": str(row["description"]),
                    "prod_type": int(row["prod_type"]),
                    "sla_configuration": int(row["sla_configuration"]),
                    "business_criticality": str(row.get("business_criticality", "medium")),
                    "platform": str(row.get("platform", "web")),
                    "lifecycle": str(row.get("lifecycle", "active"))
                }
                product_id = str(row.get("id", "")) if "id" in df.columns else ""
                self.post_or_put_to_api(data, product_id)

        except Exception as e:
            self.progress_label.configure(text=f"Import Failed: {e}", text_color="red")
            self.log_to_console(f"Import Error: {e}")
        finally:
            self.root.after(3000, lambda: self.progress_label.configure(text=""))

    def download_template(self):
        """Download Excel template with headers in the script's directory."""
        file_path = filedialog.asksaveasfilename(
            initialdir=self.script_dir,
            defaultextension=".xlsx",
            filetypes=[("Excel files", "*.xlsx")]
        )
        if not file_path:
            return

        self.progress_label.configure(text="Generating Template...")
        self.log_to_console("Generating Excel template...")
        try:
            df = pd.DataFrame(columns=["id", "name", "description", "prod_type", "sla_configuration", "business_criticality", "platform", "lifecycle"])
            df.to_excel(file_path, index=False)
            self.progress_label.configure(text="Template Generated!", text_color="green")
            self.log_to_console(f"Template saved to {file_path}")
        except Exception as e:
            self.progress_label.configure(text=f"Template Generation Failed: {e}", text_color="red")
            self.log_to_console(f"Template Error: {e}")
        finally:
            self.root.after(3000, lambda: self.progress_label.configure(text=""))

if __name__ == "__main__":
    root = ctk.CTk()
    app = ProductManagerApp(root)
    root.mainloop()