<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engagements Management Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
            height: 100vh;
            overflow-y: auto;
        }
        .container {
            max-width: 100%;
            padding: 20px;
            box-sizing: border-box;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 700;
        }
        .status-card {
            background: #ffffff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            text-align: center;
        }
        .status-card strong {
            font-weight: 700;
            margin: 0 5px;
        }
        .collapsible-section {
            background: #ffffff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px;
            font-weight: 500;
            color: #34495e;
        }
        .collapsible-header:hover {
            color: #2c3e50;
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .collapsible-content.expanded {
            max-height: 1000px;
        }
        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: nowrap;
            align-items: flex-end;
            margin-bottom: 20px;
        }
        .filter-group {
            flex: 1;
            min-width: 150px;
            position: relative;
        }
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #34495e;
        }
        .filter-group input, .filter-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        .filter-group input:focus, .filter-group select:focus {
            border-color: #58BCE2;
            outline: none;
        }
        .buttons {
            flex: 0;
            min-width: 100px;
        }
        .buttons button {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }
        #goButton {
            background-color: #007bff;
            color: white;
        }
        #goButton:hover {
            background-color: #0056b3;
        }
        #resetButton, #refreshButton, #newEngagementButton {
            background-color: #6c757d;
            color: white;
        }
        #resetButton:hover, #refreshButton:hover, #newEngagementButton:hover {
            background-color: #5a6268;
        }
        .eta-filters {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        .card {
            background: #ffffff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            flex: 1;
            min-width: 0;
        }
        .card h3 {
            margin-top: 0;
            color: #2c3e50;
            font-weight: 500;
        }
        .card input[type="date"] {
            width: 45%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin-right: 10px;
        }
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .pagination-controls button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .pagination-controls button:hover {
            background-color: #0056b3;
        }
        .pagination-controls button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #pageInfo {
            font-weight: 500;
            color: #34495e;
        }
        #loading, #error {
            text-align: center;
            padding: 20px;
        }
        #error {
            color: #e74c3c;
        }
        #loading .modal-content {
            width: 200px;
            height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            font-weight: 500;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        th {
            background-color: #58BCE2;
            color: white;
            padding: 15px;
            border: 1px solid #ddd;
            text-align: center;
            font-weight: 500;
        }
        td {
            padding: 15px;
            border: 1px solid #ddd;
            vertical-align: middle;
        }
        td button {
            background: none;
            border: none;
            cursor: pointer;
            margin-right: 10px;
            transition: transform 0.2s ease;
        }
        td button:hover {
            transform: scale(1.1);
        }
        td button svg {
            stroke: #007bff;
            transition: stroke 0.3s ease;
        }
        td button:hover svg {
            stroke: #0056b3;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s ease;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease-out;
            transform: translateY(0);
            transition: transform 0.3s ease;
            font-size: 16px;
            font-weight: 500;
            color: #34495e;
            text-align: left;
            width: 700px;
            max-width: 90%;
            min-height: 300px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-sizing: border-box;
        }
        .modal-content h2 {
            margin-top: 0;
            color: #2c3e50;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
        }
        .modal-content .row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .modal-content .row.status-row {
            grid-template-columns: repeat(3, 1fr);
        }
        .modal-content .full-width {
            grid-column: 1 / -1;
        }
        .modal-content .modal-buttons {
            text-align: center;
            margin-top: 20px;
        }
        .modal-content button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s ease;
            margin: 0 10px;
        }
        .modal-content #confirmYes, #confirmNo {
            background-color: #007bff;
            color: white;
        }
        .modal-content #confirmYes:hover, #confirmNo:hover {
            background-color: #0056b3;
        }
        #closeConfirmModal {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            color: #333;
            transition: color 0.3s ease;
        }
        #closeConfirmModal:hover {
            color: #e74c3c;
        }
        .custom-select {
            position: relative;
            width: 100%;
        }
        .custom-select .trigger {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23333' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E") no-repeat right 10px center;
            background-size: 12px;
            box-sizing: border-box;
            appearance: none;
        }
        .custom-select .dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 10px;
            width: 100%;
            box-sizing: border-box;
        }
        .custom-select .dropdown.active {
            display: block;
        }
        .custom-select .search-box {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        .custom-select .dropdown-results div {
            padding: 8px;
            cursor: pointer;
            color: #333;
            box-sizing: border-box;
        }
        .custom-select .dropdown-results div:hover {
            background-color: #f0f0f0;
        }
        .custom-select .dropdown-results .no-results {
            padding: 8px;
            color: #888;
            cursor: default;
        }
        #jiraModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        #jiraModal .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 100%;
            height: 90vh;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-sizing: border-box;
        }
        #jiraModal .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            color: #333;
            transition: color 0.3s ease;
        }
        #jiraModal .close-btn:hover {
            color: #e74c3c;
        }
        .toast {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 10px 20px;
            border-radius: 5px;
            display: none;
            z-index: 1001;
            font-size: 14px;
            width: 300px;
            text-align: center;
        }
        .toast.success {
            background-color: #28a745;
            color: white;
        }
        .toast.error {
            background-color: #e74c3c;
            color: white;
        }
        .toast.warning {
            background-color: #f1c40f;
            color: #333;
        }
        .field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .field label {
            font-weight: 500;
            color: #34495e;
        }
        .field input, .field select, .field textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .field textarea {
            min-height: 150px;
            resize: vertical;
            width: 10cm;
            height: calc(100% - 40px);
        }
        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        @keyframes rowLoading {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
        .loading-row {
            animation: rowLoading 1s infinite;
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Engagements Management Portal</h1>
        <div class="status-card" id="statusCountCard"></div>
        <div class="collapsible-section">
            <div class="collapsible-header" onclick="toggleCollapsible()">
                <span>Filters and SLA Cards</span>
                <span id="toggleIcon">▼</span>
            </div>
            <div class="collapsible-content" id="collapsibleContent">
                <div class="filters">
                    <div class="filter-group">
                        <label>Created</label>
                        <input type="date" id="createdFilter">
                    </div>
                    <div class="filter-group">
                        <label>Name</label>
                        <input type="text" id="nameFilter" placeholder="Search Name">
                        <div class="dropdown" id="nameDropdown"></div>
                    </div>
                    <div class="filter-group">
                        <label>Status</label>
                        <select id="statusFilter">
                            <option value="">All</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Mentor Status</label>
                        <select id="mentorStatusFilter">
                            <option value="">All</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Lead Status</label>
                        <select id="leadStatusFilter">
                            <option value="">All</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Assigned To</label>
                        <select id="leadFilter">
                            <option value="">All</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Product</label>
                        <select id="productFilter">
                            <option value="">All</option>
                        </select>
                    </div>
                    <div class="buttons">
                        <button id="goButton">Go</button>
                    </div>
                    <div class="buttons">
                        <button id="resetButton">Reset</button>
                    </div>
                    <div class="buttons">
                        <button id="refreshButton">Refresh</button>
                    </div>
                    <div class="buttons">
                        <button id="newEngagementButton">New Engagement</button>
                    </div>
                </div>
                <div class="eta-filters">
                    <div class="card">
                        <h2>AppSec ETA</h2>
                        <input type="date" id="appSecETA_date1">
                        <input type="date" id="appSecETA_date2">
                    </div>
                    <div class="card">
                        <h2>RM ETA</h2>
                        <input type="date" id="rmETA_date1">
                        <input type="date" id="rmETA_date2">
                    </div>
                </div>
            </div>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div class="pagination-controls" id="pagination" style="display: none;">
                <button id="prevPage">Previous</button>
                <span id="pageInfo">Page 1 of 1</span>
                <button id="nextPage">Next</button>
            </div>
            <div style="display: flex; align-items: center;">
                <label style="margin-right: 10px; line-height: 32px; font-weight: 500; color: #34495e;">Rows per page:</label>
                <select id="pageSize" style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="30">30</option>
                    <option value="40">40</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
        </div>
        <div id="loading" class="modal">
            <div class="modal-content">Loading...</div>
        </div>
        <div id="error" style="text-align: center; color: #e74c3c; padding: 20px; display: none;"></div>
        <table id="engagementTable" style="display: none;">
            <thead>
                <tr>
                    <th>Dojo ID</th>
                    <th>Created</th>
                    <th>Aging</th>
                    <th>Name</th>
                    <th>Total Jira</th>
                    <th>Pending Jira</th>
                    <th>Completed Jira</th>
                    <th>AppSec ETA</th>
                    <th>RM ETA</th>
                    <th>Assigned To</th>
                    <th>Product</th>
                    <th>Analyst Status</th>
                    <th>Mentor Status</th>					
                    <th>Lead Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>

        <!-- Edit Modal -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <h2>Edit Engagement Details</h2>
                <div class="row">
                    <div class="field">
                        <label>Dojo ID</label>
                        <input type="text" id="editId" disabled>
                    </div>
                    <div class="field">
                        <label>Name</label>
                        <input type="text" id="editName" required>
                    </div>
                    <div class="field">
                        <label>AppSec ETA</label>
                        <input type="date" id="editTargetStart" required>
                    </div>
                    <div class="field">
                        <label>RM ETA</label>
                        <input type="date" id="editTargetEnd" required>
                    </div>
                </div>
                <div class="row">
                    <div class="field custom-select">
                        <label>Assigned To</label>
                        <input type="text" class="trigger" id="editLeadTrigger" placeholder="Select Assigned To" readonly required>
                        <div class="dropdown" id="editLeadDropdown">
                            <input type="text" class="search-box" id="editLeadSearch" placeholder="Search Assigned To">
                            <div class="dropdown-results" id="editLeadResults"></div>
                        </div>
                        <input type="hidden" id="editLead" value="">
                    </div>
                    <div class="field custom-select">
                        <label>Product</label>
                        <input type="text" class="trigger" id="editProductTrigger" placeholder="Select Product" readonly required>
                        <div class="dropdown" id="editProductDropdown">
                            <input type="text" class="search-box" id="editProductSearch" placeholder="Search Product">
                            <div class="dropdown-results" id="editProductResults"></div>
                        </div>
                        <input type="hidden" id="editProduct" value="">
                    </div>
                </div>
                <div class="row full-width">
                    <div class="field">
                        <label>Description</label>
                        <textarea id="editDescription"></textarea>
                    </div>
                </div>
                <div class="row status-row">
                    <div class="field">
                        <label>Analyst Status</label>
                        <select id="editStatus" required>
                            <option value="Not Started">Not Started</option>
                            <option value="In Progress">In Progress</option>
                            <option value="On Hold">On Hold</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Mentor Status</label>
                        <select id="editMentorStatus" required>
                            <option value="Not Started">Not Started</option>
                            <option value="In Progress">In Progress</option>
                            <option value="On Hold">On Hold</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Lead Status</label>
                        <select id="editLeadStatus" required>
                            <option value="Not Started">Not Started</option>
                            <option value="Approved">Approved</option>
                            <option value="Approved with Exception">Approved with Exception</option>
                            <option value="Rejected">Rejected</option>
                        </select>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button id="saveEdit">Save</button>
                    <button id="cancelEdit">Cancel</button>
                </div>
                <div class="toast success" id="editSuccessToast">Engagement updated successfully!</div>
                <div class="toast error" id="editErrorToast"></div>
                <div class="toast warning" id="editWarningToast"></div>
            </div>
        </div>

        <!-- New Engagement Modal -->
        <div id="newEngagementModal" class="modal">
            <div class="modal-content">
                <h2>New Engagement</h2>
                <div class="row">
                    <div class="field">
                        <label>Name</label>
                        <input type="text" id="newName" required>
                    </div>
                    <div class="field">
                        <label>Created By</label>
                        <input type="text" id="newReason" required>
                    </div>
                    <div class="field custom-select">
                        <label>Assigned To</label>
                        <input type="text" class="trigger" id="newLeadTrigger" placeholder="Select Assigned To" readonly required>
                        <div class="dropdown" id="newLeadDropdown">
                            <input type="text" class="search-box" id="newLeadSearch" placeholder="Search Assigned To">
                            <div class="dropdown-results" id="newLeadResults"></div>
                        </div>
                        <input type="hidden" id="newLead" value="1">
                    </div>
                    <div class="field custom-select">
                        <label>Product</label>
                        <input type="text" class="trigger" id="newProductTrigger" placeholder="Select Product" readonly required>
                        <div class="dropdown" id="newProductDropdown">
                            <input type="text" class="search-box" id="newProductSearch" placeholder="Search Product">
                            <div class="dropdown-results" id="newProductResults"></div>
                        </div>
                        <input type="hidden" id="newProduct" value="1">
                    </div>
                </div>
                <div class="row status-row">
                    <div class="field">
                        <label>Analyst Status</label>
                        <select id="newStatus" required>
                            <option value="Not Started">Not Started</option>
                            <option value="In Progress">In Progress</option>
                            <option value="On Hold">On Hold</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Mentor Status</label>
                        <select id="newMentorStatus" required>
                            <option value="Not Started">Not Started</option>
                            <option value="In Progress">In Progress</option>
                            <option value="On Hold">On Hold</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Lead Status</label>
                        <select id="newLeadStatus" required>
                            <option value="Not Started">Not Started</option>
                            <option value="Approved">Approved</option>
                            <option value="Approved with Exception">Approved with Exception</option>
                            <option value="Rejected">Rejected</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="field">
                        <label>AppSec ETA</label>
                        <input type="date" id="newTargetStart" value="2025-06-22" required>
                    </div>
                    <div class="field">
                        <label>RM ETA</label>
                        <input type="date" id="newTargetEnd" value="2025-06-22" required>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button id="saveNew">Save</button>
                    <button id="closeNew">Close</button>
                </div>
                <div class="toast success" id="newEngagementToast">Engagement created successfully!</div>
                <div class="toast error" id="newErrorToast"></div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirmModal" class="modal">
            <div class="modal-content">
                <button id="closeConfirmModal">×</button>
                <h2>Confirm Action</h2>
                <p id="confirmMessage">Do you want to close this engagement?</p>
                <div class="row modal-buttons">
                    <button id="confirmYes">Yes</button>
                    <button id="confirmNo">No</button>
                </div>
                <div class="toast success" id="confirmSuccessToast" style="position: relative; top: 20px; right: auto; left: auto; display: none;">Engagement closed successfully!</div>
                <div class="toast error" id="confirmErrorToast"></div>
            </div>
        </div>

        <!-- Jira Modal -->
        <div id="jiraModal" class="modal">
            <div class="modal-content">
                <button class="close-btn" id="closeJiraModal">×</button>
                <div id="jiraContent"></div>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let pageSize = 10;
        let filteredData = [];
        let apiData = [];
        let usersData = [];
        let productsData = [];
        let csrfToken = '';
        let currentEditId = null;
        let currentCloseId = null;

        // Current date for Aging calculation (June 22, 2025, 01:11 PM IST)
        const today = new Date('2025-06-22T13:11:00+05:30');

        async function fetchCsrfToken() {
            try {
                const response = await fetch('https://demo.defectdojo.org/api/key-v2', {
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('Failed to fetch CSRF token');
                const text = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const tokenInput = doc.querySelector('input[name="csrfmiddlewaretoken"]');
                csrfToken = tokenInput ? tokenInput.value : '';
                console.log('CSRF Token fetched:', csrfToken);
            } catch (err) {
                console.error('Error fetching CSRF token:', err);
            }
        }

        async function fetchData() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const table = document.getElementById('engagementTable');
            const pagination = document.getElementById('pagination');
            loading.style.display = 'flex';
            error.style.display = 'none';
            table.style.display = 'none';
            pagination.style.display = 'none';

            try {
                await fetchCsrfToken();
                const [engagementsResponse, usersResponse, productsResponse] = await Promise.all([
                    fetch('https://demo.defectdojo.org/api/v2/engagements/?tags=pci&limit=10000&active=true', {
                        credentials: 'include',
                        headers: { 'X-CSRFToken': csrfToken }
                    }),
                    fetch('https://demo.defectdojo.org/api/v2/users/', {
                        credentials: 'include',
                        headers: { 'X-CSRFToken': csrfToken }
                    }),
                    fetch('https://demo.defectdojo.org/api/v2/products', {
                        credentials: 'include',
                        headers: { 'X-CSRFToken': csrfToken }
                    })
                ]);
                if (!engagementsResponse.ok) throw new Error(`Engagements API error: ${engagementsResponse.status}`);
                if (!usersResponse.ok) throw new Error(`Users API error: ${usersResponse.status}`);
                if (!productsResponse.ok) throw new Error(`Products API error: ${productsResponse.status}`);
                apiData = (await engagementsResponse.json()).results || [];
                const usersResult = await usersResponse.json();
                usersData = Array.isArray(usersResult.results) ? usersResult.results : usersResult || [];
                const productsResult = await productsResponse.json();
                productsData = Array.isArray(productsResult.results) ? productsResult.results : productsResult || [];
                console.log('Users Data:', usersData);
                console.log('Products Data:', productsData);
                filteredData = [...apiData];
                populateDynamicFilters();
                populateTableDropdowns();
                initializeDropdowns();
                updateStatusCounts();
                loading.style.display = 'none';
                table.style.display = 'table';
                pagination.style.display = 'flex';
                renderTable();
            } catch (err) {
                loading.style.display = 'none';
                error.style.display = 'block';
                error.textContent = 'Error fetching data: ' + err.message;
                console.error('Fetch error:', err);
            }
        }

        async function fetchJiraCounts(engagementId) {
            try {
                const response = await fetch(`https://demo.defectdojo.org/api/v2/tests/?engagement=${engagementId}&tags=mcr_jira`, {
                    credentials: 'include',
                    headers: { 'X-CSRFToken': csrfToken }
                });
                if (!response.ok) throw new Error(`Failed to fetch Jira data for engagement ${engagementId}: ${response.status}`);
                const data = await response.json();
                const tests = data.results || [];
                const pendingCount = tests.filter(test => ['Pending', 'On Hold'].includes(test.branch_tag)).length;
                const completedCount = tests.filter(test => ['Rejected', 'Completed'].includes(test.branch_tag)).length;
                return {
                    total: pendingCount + completedCount,
                    pending: pendingCount,
                    completed: completedCount
                };
            } catch (err) {
                console.error('Error fetching Jira counts:', err);
                return { total: 0, pending: 0, completed: 0 };
            }
        }

        function populateDynamicFilters() {
            const statusFilter = document.getElementById('statusFilter');
            const mentorStatusFilter = document.getElementById('mentorStatusFilter');
            const leadStatusFilter = document.getElementById('leadStatusFilter');
            const uniqueStatuses = ["Not Started", "In Progress", "On Hold", "Completed"];
            const uniqueLeadStatuses = ["Not Started", "Approved", "Approved with Exception", "Rejected"];

            statusFilter.innerHTML = '<option value="">All</option>';
            mentorStatusFilter.innerHTML = '<option value="">All</option>';
            leadStatusFilter.innerHTML = '<option value="">All</option>';

            uniqueStatuses.forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                statusFilter.appendChild(option.cloneNode(true));
                mentorStatusFilter.appendChild(option.cloneNode(true));
            });

            uniqueLeadStatuses.forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                leadStatusFilter.appendChild(option);
            });
        }

        function populateTableDropdowns() {
            const leadFilter = document.getElementById('leadFilter');
            const productFilter = document.getElementById('productFilter');

            leadFilter.innerHTML = '<option value="">All</option>';
            productFilter.innerHTML = '<option value="">All</option>';

            const uniqueLeads = [...new Set(apiData.map(item => item.lead).filter(id => id !== null).map(id => {
                const user = usersData.find(u => u.id === id);
                return user ? `${user.first_name} ${user.last_name}`.trim() || 'N/A' : 'N/A';
            }))];
            const uniqueProducts = [...new Set(apiData.map(item => item.product).filter(id => id !== null).map(id => {
                const product = productsData.find(p => p.id === id);
                return product ? product.name || 'N/A' : 'N/A';
            }))];

            uniqueLeads.forEach((leadName, index) => {
                const option = document.createElement('option');
                const leadId = apiData.find(item => item.lead && `${usersData.find(u => u.id === item.lead)?.first_name || ''} ${usersData.find(u => u.id === item.lead)?.last_name || ''}`.trim() === leadName)?.lead || index;
                option.value = leadId;
                option.textContent = leadName;
                leadFilter.appendChild(option);
            });

            uniqueProducts.forEach((productName, index) => {
                const option = document.createElement('option');
                const productId = apiData.find(item => item.product && productsData.find(p => p.id === item.product)?.name === productName)?.product || index;
                option.value = productId;
                option.textContent = productName;
                productFilter.appendChild(option);
            });
        }

        function setupSearchableDropdown(triggerId, dropdownId, searchId, resultsId, dataSource, getValue, hiddenId) {
            const trigger = document.getElementById(triggerId);
            const dropdown = document.getElementById(dropdownId);
            const search = document.getElementById(searchId);
            const results = document.getElementById(resultsId);
            const hidden = document.getElementById(hiddenId);

            trigger.addEventListener('click', () => {
                dropdown.classList.add('active');
                search.focus();
                updateResults('');
            });

            search.addEventListener('input', debounce((e) => {
                updateResults(e.target.value);
            }, 300));

            function updateResults(value) {
                results.innerHTML = '';
                const lowerValue = value.toLowerCase();
                const matches = dataSource.filter(item => !lowerValue || getValue(item).toLowerCase().includes(lowerValue));
                if (matches.length === 0) {
                    const div = document.createElement('div');
                    div.textContent = 'No matches found';
                    div.className = 'no-results';
                    results.appendChild(div);
                } else {
                    matches.forEach(item => {
                        const div = document.createElement('div');
                        div.textContent = getValue(item);
                        div.dataset.id = item.id;
                        div.addEventListener('click', () => {
                            trigger.value = getValue(item);
                            hidden.value = item.id;
                            dropdown.classList.remove('active');
                        });
                        results.appendChild(div);
                    });
                }
            }

            document.addEventListener('click', (e) => {
                if (!dropdown.contains(e.target) && e.target !== trigger) {
                    dropdown.classList.remove('active');
                }
            });

            trigger.addEventListener('focus', () => {
                if (hidden.value && !trigger.value) {
                    const selectedItem = dataSource.find(item => item.id === parseInt(hidden.value));
                    if (selectedItem) trigger.value = getValue(selectedItem);
                }
                if (!dropdown.classList.contains('active')) {
                    dropdown.classList.add('active');
                    search.focus();
                    updateResults(trigger.value || '');
                }
            });

            trigger.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !trigger.value && hidden.value) {
                    hidden.value = '';
                    trigger.value = '';
                }
            });
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        async function renderTable() {
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const paginatedData = filteredData.slice(start, end);

            const tbody = document.getElementById('tableBody');
            if (start === 0) {
                tbody.innerHTML = ''; // Clear only on first page render
            }

            for (const item of paginatedData) {
                const leadName = item.lead ? `${usersData.find(u => u.id === item.lead)?.first_name || ''} ${usersData.find(u => u.id === item.lead)?.last_name || ''}`.trim() || 'N/A' : 'N/A';
                const productName = item.product ? productsData.find(p => p.id === item.product)?.name || 'N/A' : 'N/A';
                const leadStatus = item.commit_hash || 'Not Started';
                const mentorStatus = item.branch_tag || 'Not Started';
                const createdDate = item.created ? new Date(item.created).toISOString().split('T')[0] : 'N/A';
                const aging = item.created ? Math.floor((today - new Date(item.created)) / (1000 * 60 * 60 * 24)) : 'N/A';
                const jiraCounts = await fetchJiraCounts(item.id);

                let row = tbody.querySelector(`tr[data-id="${item.id}"]`);
                if (!row) {
                    row = document.createElement('tr');
                    row.dataset.id = item.id;
                    tbody.appendChild(row);
                }

                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${createdDate}</td>
                    <td>${aging}</td>
                    <td>${item.name || 'N/A'}</td>
                    <td>${jiraCounts.total}</td>
                    <td>${jiraCounts.pending}</td>
                    <td>${jiraCounts.completed}</td>
                    <td>${item.target_start ? new Date(item.target_start).toISOString().split('T')[0] : 'N/A'}</td>
                    <td>${item.target_end ? new Date(item.target_end).toISOString().split('T')[0] : 'N/A'}</td>
                    <td>${leadName}</td>
                    <td>${productName}</td>
                    <td>${item.status || 'N/A'}</td>
                    <td>${mentorStatus}</td>					
                    <td>${leadStatus}</td>
                    <td style="text-align: center;">
                        <button class="editBtn" data-id="${item.id}" title="Edit"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#007bff" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                        <button class="closeBtn" data-id="${item.id}" title="Close Engagement"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#007bff" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"></path></svg></button>
                        <button class="reportBtn" data-id="${item.id}" title="Fetch Report"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#007bff" stroke-width="2"><path d="M19 20H5c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2h14c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2zm-8.5-2h3c.28 0 .5-.22.5-.5s-.22-.5-.5-.5h-3c-.28 0-.5.22-.5.5s.22.5.5.5zm4.5-3H6V7h9.5v8zm3.5 1h-2v-6h2v6z"></path></svg></button>
                    </td>
                `;
            }

            const totalPages = Math.ceil(filteredData.length / pageSize);
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages || 1}`;
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages || totalPages === 0;

            // Reattach event listeners after rendering
            attachActionListeners();
        }

        function attachActionListeners() {
            document.querySelectorAll('.editBtn').forEach(btn => {
                btn.removeEventListener('click', openEditModal); // Remove existing listener to avoid duplicates
                btn.addEventListener('click', () => openEditModal(btn.dataset.id));
            });
            document.querySelectorAll('.closeBtn').forEach(btn => {
                btn.removeEventListener('click', openConfirmModal); // Remove existing listener to avoid duplicates
                btn.addEventListener('click', () => openConfirmModal(btn.dataset.id));
            });
            document.querySelectorAll('.reportBtn').forEach(btn => {
                btn.removeEventListener('click', reportClickHandler); // Remove existing listener to avoid duplicates
                btn.addEventListener('click', () => reportClickHandler(btn.dataset.id));
            });
        }

        function reportClickHandler(id) {
            alert(`Fetch Report for ID ${id}`);
        }

        function applyFilters() {
            const loading = document.getElementById('loading');
            loading.style.display = 'flex';

            const created = document.getElementById('createdFilter').value;
            const name = document.getElementById('nameFilter').value.trim().toLowerCase();
            const status = document.getElementById('statusFilter').value;
            const mentorStatus = document.getElementById('mentorStatusFilter').value;
            const leadStatus = document.getElementById('leadStatusFilter').value;
            const lead = document.getElementById('leadFilter').value;
            const product = document.getElementById('productFilter').value;
            const appSecETA1 = document.getElementById('appSecETA_date1').value;
            const appSecETA2 = document.getElementById('appSecETA_date2').value;
            const rmETA1 = document.getElementById('rmETA_date1').value;
            const rmETA2 = document.getElementById('rmETA_date2').value;

            filteredData = apiData.filter(item => {
                const leadName = item.lead ? `${usersData.find(u => u.id === item.lead)?.first_name || ''} ${usersData.find(u => u.id === item.lead)?.last_name || ''}`.trim().toLowerCase() : '';
                const productName = item.product ? productsData.find(p => p.id === item.product)?.name.toLowerCase() || '' : '';
                const targetStart = item.target_start ? new Date(item.target_start).toISOString().split('T')[0] : '';
                const targetEnd = item.target_end ? new Date(item.target_end).toISOString().split('T')[0] : '';
                const createdDate = item.created ? new Date(item.created).toISOString().split('T')[0] : '';
                const itemMentorStatus = item.branch_tag || 'Not Started';

                return (
                    (!created || (createdDate === created)) &&
                    (!name || (item.name && item.name.toLowerCase().includes(name))) &&
                    (!status || (item.status || 'N/A') === status) &&
                    (!mentorStatus || (itemMentorStatus === mentorStatus)) &&
                    (!leadStatus || (item.commit_hash || 'Not Started') === leadStatus) &&
                    (!lead || (item.lead && item.lead.toString() === lead)) &&
                    (!product || (item.product && item.product.toString() === product)) &&
                    (!appSecETA1 || !appSecETA2 || (targetStart >= appSecETA1 && targetStart <= appSecETA2)) &&
                    (!rmETA1 || !rmETA2 || (targetEnd >= rmETA1 && targetEnd <= rmETA2))
                );
            });

            currentPage = 1;
            loading.style.display = 'none';
            updateStatusCounts();
            renderTable();
        }

        function setupRealtimeDropdown(inputId, dropdownId, getValue, dataSource) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);

            input.addEventListener('input', () => {
                const value = input.value.toLowerCase();
                dropdown.innerHTML = '';
                if (value) {
                    const matches = dataSource.filter(item => getValue(item).toLowerCase().includes(value));
                    matches.forEach(item => {
                        const div = document.createElement('div');
                        div.textContent = getValue(item);
                        div.addEventListener('click', () => {
                            input.value = getValue(item);
                            dropdown.style.display = 'none';
                            applyFilters();
                        });
                        dropdown.appendChild(div);
                    });
                    dropdown.style.display = matches.length ? 'block' : 'none';
                } else {
                    dropdown.style.display = 'none';
                }
            });

            input.addEventListener('blur', () => {
                setTimeout(() => dropdown.style.display = 'none', 200);
            });
        }

        async function openEditModal(id) {
            const item = apiData.find(item => item.id === parseInt(id));
            if (!item) return;

            currentEditId = id;
            const editModal = document.getElementById('editModal');
            const row = document.querySelector(`tr[data-id="${id}"]`);
            if (row) {
                row.classList.add('loading-row');
            }

            const fields = {
                editId: item.id,
                editName: item.name || '',
                editDescription: item.description || '',
                editTargetStart: item.target_start ? new Date(item.target_start).toISOString().split('T')[0] : '',
                editTargetEnd: item.target_end ? new Date(item.target_end).toISOString().split('T')[0] : '',
                editStatus: item.status || 'Not Started',
                editLead: item.lead || '',
                editProduct: item.product || '',
                editLeadStatus: item.commit_hash || 'Not Started',
                editMentorStatus: item.branch_tag || 'Not Started'
            };

            Object.entries(fields).forEach(([fieldId, value]) => {
                const element = document.getElementById(fieldId);
                if (element) {
                    if (element.type === 'select-one') {
                        element.value = value;
                    } else if (element.classList.contains('trigger')) {
                        const triggerValue = fieldId === 'editLead' ? (item.lead ? `${usersData.find(u => u.id === item.lead)?.first_name || ''} ${usersData.find(u => u.id === item.lead)?.last_name || ''}`.trim() : '') :
                                        (fieldId === 'editProduct' ? (item.product ? productsData.find(p => p.id === item.product)?.name || '' : '') : value);
                        element.value = triggerValue;
                        document.getElementById(fieldId.replace('Trigger', '')).value = value;
                    } else {
                        element.value = value;
                    }
                }
            });

            document.getElementById('editSuccessToast').style.display = 'none';
            document.getElementById('editErrorToast').style.display = 'none';
            document.getElementById('editWarningToast').style.display = 'none';
            editModal.style.display = 'flex';
        }

        async function saveEdit() {
            const id = currentEditId;
            const name = document.getElementById('editName').value.trim();
            const description = document.getElementById('editDescription').value.trim();
            const target_start = document.getElementById('editTargetStart').value;
            const target_end = document.getElementById('editTargetEnd').value;
            const status = document.getElementById('editStatus').value;
            const lead = document.getElementById('editLead').value;
            const product = document.getElementById('editProduct').value;
            const leadStatus = document.getElementById('editLeadStatus').value;
            const mentorStatus = document.getElementById('editMentorStatus').value;

            if (!name || !target_start || !target_end || !lead || !product || !leadStatus || !mentorStatus) {
                document.getElementById('editErrorToast').textContent = 'All required fields must be filled';
                document.getElementById('editErrorToast').style.display = 'block';
                setTimeout(() => document.getElementById('editErrorToast').style.display = 'none', 3000);
                return;
            }

            if (new Date(target_start) > new Date(target_end)) {
                document.getElementById('editWarningToast').textContent = 'Warning: AppSec ETA cannot be later than RM ETA';
                document.getElementById('editWarningToast').style.display = 'block';
                setTimeout(() => document.getElementById('editWarningToast').style.display = 'none', 3000);
                return;
            }

            const row = document.querySelector(`tr[data-id="${id}"]`);
            if (row) {
                row.classList.add('loading-row');
            }

            try {
                const response = await fetch(`https://demo.defectdojo.org/api/v2/engagements/${id}/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        id: parseInt(id),
                        name,
                        description: description || null,
                        target_start,
                        target_end,
                        status,
                        lead: parseInt(lead),
                        product: parseInt(product),
                        commit_hash: leadStatus,
                        branch_tag: mentorStatus
                    })
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to update engagement: ${errorText}`);
                }
                const updatedItem = await response.json();
                const index = apiData.findIndex(item => item.id === parseInt(id));
                if (index !== -1) {
                    apiData[index] = updatedItem;
                    filteredData = [...apiData];
                }
                if (row) {
                    const leadName = updatedItem.lead ? `${usersData.find(u => u.id === updatedItem.lead)?.first_name || ''} ${usersData.find(u => u.id === updatedItem.lead)?.last_name || ''}`.trim() || 'N/A' : 'N/A';
                    const productName = updatedItem.product ? productsData.find(p => p.id === updatedItem.product)?.name || 'N/A' : 'N/A';
                    const createdDate = updatedItem.created ? new Date(updatedItem.created).toISOString().split('T')[0] : 'N/A';
                    const aging = updatedItem.created ? Math.floor((today - new Date(updatedItem.created)) / (1000 * 60 * 60 * 24)) : 'N/A';
                    const jiraCounts = await fetchJiraCounts(updatedItem.id);
                    row.innerHTML = `
                        <td>${updatedItem.id}</td>
                        <td>${createdDate}</td>
                        <td>${aging}</td>
                        <td>${updatedItem.name || 'N/A'}</td>
                        <td>${jiraCounts.total}</td>
                        <td>${jiraCounts.pending}</td>
                        <td>${jiraCounts.completed}</td>
                        <td>${updatedItem.target_start ? new Date(updatedItem.target_start).toISOString().split('T')[0] : 'N/A'}</td>
                        <td>${updatedItem.target_end ? new Date(updatedItem.target_end).toISOString().split('T')[0] : 'N/A'}</td>
                        <td>${leadName}</td>
                        <td>${productName}</td>
                        <td>${updatedItem.status || 'N/A'}</td>
                        <td>${updatedItem.branch_tag || 'Not Started'}</td>					
                        <td>${updatedItem.commit_hash || 'Not Started'}</td>
                        <td style="text-align: center;">
                            <button class="editBtn" data-id="${updatedItem.id}" title="Edit"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#007bff" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                            <button class="closeBtn" data-id="${updatedItem.id}" title="Close Engagement"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#007bff" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"></path></svg></button>
                            <button class="reportBtn" data-id="${updatedItem.id}" title="Fetch Report"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#007bff" stroke-width="2"><path d="M19 20H5c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2h14c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2zm-8.5-2h3c.28 0 .5-.22.5-.5s-.22-.5-.5-.5h-3c-.28 0-.5.22-.5.5s.22.5.5.5zm4.5-3H6V7h9.5v8zm3.5 1h-2v-6h2v6z"></path></svg></button>
                        </td>
                    `;
                    row.classList.remove('loading-row');
                    attachActionListeners(); // Reattach event listeners after row update
                }
                updateStatusCounts();
                document.getElementById('editSuccessToast').style.display = 'block';
                setTimeout(() => document.getElementById('editSuccessToast').style.display = 'none', 3000);
            } catch (err) {
                if (row) row.classList.remove('loading-row');
                document.getElementById('editErrorToast').textContent = 'Error updating engagement: ' + err.message;
                document.getElementById('editErrorToast').style.display = 'block';
                setTimeout(() => document.getElementById('editErrorToast').style.display = 'none', 3000);
            }

            document.getElementById('editModal').style.display = 'none';
        }

        async function openJiraModal(id) {
            const jiraModal = document.getElementById('jiraModal');
            const jiraContent = document.getElementById('jiraContent');
            jiraModal.style.display = 'flex';

            try {
                const response = await fetch('https://demo.defectdojo.org/media/uploaded_files/8e2a1fe5-72f7-4893-86c1-cdb1c01575d7.html');
                if (!response.ok) throw new Error('Failed to fetch Jira content');
                const html = await response.text();
                jiraContent.innerHTML = html;
            } catch (err) {
                jiraContent.innerHTML = '<p>Error loading Jira content: ' + err.message + '</p>';
            }
        }

        function initializeDropdowns() {
            setupSearchableDropdown('editLeadTrigger', 'editLeadDropdown', 'editLeadSearch', 'editLeadResults', usersData, user => `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'N/A', 'editLead');
            setupSearchableDropdown('editProductTrigger', 'editProductDropdown', 'editProductSearch', 'editProductResults', productsData, product => product.name || 'N/A', 'editProduct');
            setupSearchableDropdown('newLeadTrigger', 'newLeadDropdown', 'newLeadSearch', 'newLeadResults', usersData, user => `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'N/A', 'newLead');
            setupSearchableDropdown('newProductTrigger', 'newProductDropdown', 'newProductSearch', 'newProductResults', productsData, product => product.name || 'N/A', 'newProduct');
        }

        function updateStatusCounts() {
            const notStartedCount = filteredData.filter(item => item.status === 'Not Started').length;
            const inProgressCount = filteredData.filter(item => item.status === 'In Progress').length;
            const onHoldCount = filteredData.filter(item => item.status === 'On Hold').length;
            const totalCount = notStartedCount + inProgressCount + onHoldCount;

            const statusCard = document.getElementById('statusCountCard');
            statusCard.innerHTML = `<strong>Not Started: ${notStartedCount}</strong> | <strong>In Progress: ${inProgressCount}</strong> | <strong>On Hold: ${onHoldCount}</strong> | <strong>TOTAL: ${totalCount}</strong>`;
        }

        function toggleCollapsible() {
            const content = document.getElementById('collapsibleContent');
            const toggleIcon = document.getElementById('toggleIcon');
            content.classList.toggle('expanded');
            toggleIcon.textContent = content.classList.contains('expanded') ? '▲' : '▼';
        }

        async function saveNewEngagement() {
            const name = document.getElementById('newName').value.trim();
            const reason = document.getElementById('newReason').value.trim();
            const target_start = document.getElementById('newTargetStart').value;
            const target_end = document.getElementById('newTargetEnd').value;
            const status = document.getElementById('newStatus').value;
            const lead = document.getElementById('newLead').value;
            const product = document.getElementById('newProduct').value;
            const leadStatus = document.getElementById('newLeadStatus').value;
            const mentorStatus = document.getElementById('newMentorStatus').value;

            if (!name || !reason || !target_start || !target_end || !lead || !product || !leadStatus || !mentorStatus) {
                document.getElementById('newErrorToast').textContent = 'All fields are required';
                document.getElementById('newErrorToast').style.display = 'block';
                setTimeout(() => document.getElementById('newErrorToast').style.display = 'none', 3000);
                return;
            }

            try {
                const response = await fetch('https://demo.defectdojo.org/api/v2/engagements/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        tags: ["pci"],
                        name,
                        target_start,
                        target_end,
                        engagement_type: "Interactive",
                        status,
                        commit_hash: leadStatus,
                        branch_tag: mentorStatus,
                        lead: parseInt(lead),
                        product: parseInt(product),
                        reason
                    })
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to create engagement: ${errorText}`);
                }
                const newItem = await response.json();
                apiData.push(newItem);
                filteredData = [...apiData];
                updateStatusCounts();
                renderTable();
                document.getElementById('newEngagementToast').style.display = 'block';
                setTimeout(() => document.getElementById('newEngagementToast').style.display = 'none', 3000);
                document.getElementById('newEngagementModal').style.display = 'none';
            } catch (err) {
                document.getElementById('newErrorToast').textContent = 'Error creating engagement: ' + err.message;
                document.getElementById('newErrorToast').style.display = 'block';
                setTimeout(() => document.getElementById('newErrorToast').style.display = 'none', 3000);
            }
        }

        function openConfirmModal(id) {
            currentCloseId = id;
            document.getElementById('confirmMessage').textContent = 'Do you want to close this engagement?';
            document.getElementById('confirmSuccessToast').style.display = 'none';
            document.getElementById('confirmErrorToast').style.display = 'none';
            document.getElementById('confirmModal').style.display = 'flex';
        }

        async function closeEngagement() {
            const id = currentCloseId;
            try {
                const response = await fetch(`https://demo.defectdojo.org/api/v2/engagements/${id}/close/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    credentials: 'include'
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to close engagement: ${errorText}`);
                }
                let updatedItem;
                try {
                    updatedItem = await response.json();
                } catch (jsonError) {
                    console.warn('API response is not JSON, treating as success:', response.statusText);
                    updatedItem = { id: parseInt(id), status: 'Closed' };
                }
                const index = apiData.findIndex(item => item.id === parseInt(id));
                if (index !== -1) {
                    apiData.splice(index, 1);
                    filteredData = [...apiData];
                }
                const row = document.querySelector(`tr[data-id="${id}"]`);
                if (row) {
                    row.remove(); // Remove the row from the DOM
                    updateStatusCounts();
                    renderTable(); // Re-render the table to adjust pagination and reattach listeners
                }
                document.getElementById('confirmSuccessToast').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('confirmModal').style.display = 'none';
                    document.getElementById('confirmSuccessToast').style.display = 'none';
                    document.getElementById('confirmMessage').textContent = 'Do you want to close this engagement?';
                }, 2000);
            } catch (err) {
                document.getElementById('confirmErrorToast').textContent = 'Error closing engagement: ' + err.message;
                document.getElementById('confirmErrorToast').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('confirmErrorToast').style.display = 'none';
                    document.getElementById('confirmModal').style.display = 'none';
                    document.getElementById('confirmMessage').textContent = 'Do you want to close this engagement?';
                }, 2000);
            }
        }

        document.getElementById('goButton').addEventListener('click', applyFilters);
        document.getElementById('resetButton').addEventListener('click', () => {
            const loading = document.getElementById('loading');
            loading.style.display = 'flex';
            setTimeout(() => {
                document.getElementById('createdFilter').value = '';
                document.getElementById('nameFilter').value = '';
                document.getElementById('statusFilter').value = '';
                document.getElementById('mentorStatusFilter').value = '';
                document.getElementById('leadStatusFilter').value = '';
                document.getElementById('leadFilter').value = '';
                document.getElementById('productFilter').value = '';
                document.getElementById('appSecETA_date1').value = '';
                document.getElementById('appSecETA_date2').value = '';
                document.getElementById('rmETA_date1').value = '';
                document.getElementById('rmETA_date2').value = '';
                filteredData = [...apiData];
                currentPage = 1;
                updateStatusCounts();
                renderTable();
                loading.style.display = 'none';
            }, 0);
        });
        document.getElementById('refreshButton').addEventListener('click', () => {
            const loading = document.getElementById('loading');
            loading.style.display = 'flex';
            setTimeout(async () => {
                await fetchData();
                loading.style.display = 'none';
            }, 0);
        });
        document.getElementById('newEngagementButton').addEventListener('click', () => {
            document.getElementById('newEngagementModal').style.display = 'flex';
            document.getElementById('newName').value = '';
            document.getElementById('newReason').value = '';
            document.getElementById('newLeadTrigger').value = usersData.find(u => u.id === 1) ? `${usersData.find(u => u.id === 1)?.first_name || ''} ${usersData.find(u => u.id === 1)?.last_name || ''}`.trim() : '';
            document.getElementById('newLead').value = '1';
            document.getElementById('newProductTrigger').value = productsData.find(p => p.id === 1) ? productsData.find(p => p.id === 1).name || '' : '';
            document.getElementById('newProduct').value = '1';
            document.getElementById('newStatus').value = 'Not Started';
            document.getElementById('newMentorStatus').value = 'Not Started';
            document.getElementById('newLeadStatus').value = 'Not Started';
            document.getElementById('newTargetStart').value = '2025-06-22';
            document.getElementById('newTargetEnd').value = '2025-06-22';
        });
        document.getElementById('pageSize').addEventListener('change', (e) => {
            pageSize = parseInt(e.target.value);
            currentPage = 1;
            renderTable();
        });
        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        });
        document.getElementById('nextPage').addEventListener('click', () => {
            const totalPages = Math.ceil(filteredData.length / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        });
        document.getElementById('cancelEdit').addEventListener('click', () => {
            const row = document.querySelector(`tr[data-id="${currentEditId}"]`);
            if (row) row.classList.remove('loading-row');
            document.getElementById('editModal').style.display = 'none';
        });
        document.getElementById('saveEdit').addEventListener('click', saveEdit);
        document.getElementById('saveNew').addEventListener('click', saveNewEngagement);
        document.getElementById('closeNew').addEventListener('click', () => {
            document.getElementById('newEngagementModal').style.display = 'none';
        });
        document.getElementById('closeJiraModal').addEventListener('click', () => {
            document.getElementById('jiraModal').style.display = 'none';
            document.getElementById('jiraContent').innerHTML = '';
        });
        document.getElementById('closeConfirmModal').addEventListener('click', () => {
            document.getElementById('confirmModal').style.display = 'none';
            document.getElementById('confirmSuccessToast').style.display = 'none';
            document.getElementById('confirmErrorToast').style.display = 'none';
            document.getElementById('confirmMessage').textContent = 'Do you want to close this engagement?';
        });
        document.getElementById('confirmYes').addEventListener('click', () => {
            closeEngagement();
        });
        document.getElementById('confirmNo').addEventListener('click', () => {
            document.getElementById('confirmModal').style.display = 'none';
            document.getElementById('confirmSuccessToast').style.display = 'none';
            document.getElementById('confirmErrorToast').style.display = 'none';
            document.getElementById('confirmMessage').textContent = 'Do you want to close this engagement?';
        });

        setupRealtimeDropdown('nameFilter', 'nameDropdown', item => item.name || 'N/A', apiData);

        fetchData();
    </script>
</body>
</html>