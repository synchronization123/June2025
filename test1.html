<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DefectDojo Engagement Manager</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f7fa;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .filters select, .filters input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .filters button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s, transform 0.1s;
        }
        .filters button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .filters button:active {
            transform: translateY(0);
        }
        .btn-reset { background-color: #f44336; color: white; }
        .btn-refresh { background-color: #2196f3; color: white; }
        .btn-go { background-color: #4caf50; color: white; }
        .btn-new { background-color: #ff9800; color: white; }
        .table-container {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #2196f3;
            color: white;
        }
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            background-color: #2196f3;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
        }
        .action-btn:hover {
            background-color: #1976d2;
            transform: translateY(-1px);
        }
        .action-btn:active {
            transform: translateY(0);
        }
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .pagination button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .modal.show {
            display: flex;
            opacity: 1;
        }
        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            width: 450px;
            transform: translateY(-50px);
            transition: transform 0.3s ease-in-out;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .modal.show .modal-content {
            transform: translateY(0);
        }
        .modal-content p {
            margin: 0 0 15px;
            color: #555;
            font-size: 14px;
        }
        .modal-content input, .modal-content select, .modal-content textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .modal-content textarea {
            height: 70px; /* ~7cm */
            width: 150px; /* ~15cm */
            resize: none;
        }
        .modal-content button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
        }
        .modal-content button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .modal-content button:active {
            transform: translateY(0);
        }
        .btn-save { background-color: #4caf50; color: white; }
        .btn-cancel { background-color: #f44336; color: white; }
        .toast {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            transition: opacity 0.3s;
        }
        .toast.show {
            display: block;
            opacity: 1;
        }
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .loading.show {
            display: flex;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2196f3;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="filters">
            <select id="version-filter"><option value="">Select Version</option></select>
            <select id="product-filter"><option value="">Select Product</option></select>
            <select id="vp-filter"><option value="">Select VP</option></select>
            <select id="dev-mentor-filter"><option value="">Select Dev Mentor</option></select>
            <select id="owners-filter"><option value="">Select Owners</option></select>
            <select id="alf-status-filter">
                <option value="">Select ALF Status</option>
                <option value="Completed">Already Covered in ALF</option>
                <option value="On Hold">Not Covered by ALF</option>
                <option value="Blocked">Not Applicable for ALF</option>
                <option value="Cancelled">Retired/Deactivated</option>
                <option value="Waiting for Resource">ALF Required/Response Received</option>
                <option value="Not Started">Not Started</option>
                <option value="In Progress">In Progress</option>
            </select>
            <input type="text" id="repolinks-filter" placeholder="Search RepoLinks">
            <input type="text" id="comments-filter" placeholder="Search Comments">
            <select id="analyst-filter"><option value="">Select Analyst</option></select>
            <button class="btn-reset" onclick="resetFilters()">Reset</button>
            <button class="btn-refresh" onclick="fetchData()">Refresh</button>
            <button class="btn-go" onclick="applyFilters()">Go</button>
            <button class="btn-new" onclick="openNewModal()">New</button>
        </div>
        <div class="pagination">
            <button onclick="changePage(-1)" id="prev-page">Previous</button>
            <span id="page-info"></span>
            <button onclick="changePage(1)" id="next-page">Next</button>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Project</th>
                        <th>Product</th>
                        <th>VP</th>
                        <th>Dev Mentor</th>
                        <th>Owners</th>
                        <th>ALF Status</th>
                        <th>RepoLinks</th>
                        <th>Final List</th>
                        <th>Comments</th>
                        <th>Analyst</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
        <div class="modal" id="edit-modal">
            <div class="modal-content">
                <h2>Edit Engagement</h2>
                <p>Update engagement details and save changes.</p>
                <input type="text" id="modal-project" readonly>
                <input type="text" id="modal-product" readonly>
                <input type="text" id="modal-vp" placeholder="Enter VP">
                <input type="text" id="modal-dev-mentor" placeholder="Enter Dev Mentor">
                <input type="text" id="modal-owners" placeholder="Enter Owners">
                <select id="modal-alf-status">
                    <option value="Completed">Already Covered in ALF</option>
                    <option value="On Hold">Not Covered by ALF</option>
                    <option value="Blocked">Not Applicable for ALF</option>
                    <option value="Cancelled">Retired/Deactivated</option>
                    <option value="Waiting for Resource">ALF Required/Response Received</option>
                    <option value="Not Started">Not Started</option>
                    <option value="In Progress">In Progress</option>
                </select>
                <input type="text" id="modal-repolinks" placeholder="Enter RepoLinks">
                <select id="modal-analyst"></select>
                <textarea id="modal-comments" placeholder="Enter Comments"></textarea>
                <button class="btn-save" onclick="saveChanges()">Save</button>
                <button class="btn-cancel" onclick="cancelEdit()">Cancel</button>
            </div>
        </div>
        <div class="modal" id="new-modal">
            <div class="modal-content">
                <h2>Create New Engagement</h2>
                <p>Enter details for the new engagement. All fields are required where indicated.</p>
                <input type="text" id="new-project" placeholder="Enter Project (Version)">
                <input type="text" id="new-product" placeholder="Enter Product (required)">
                <input type="text" id="new-vp" placeholder="Enter VP">
                <input type="text" id="new-dev-mentor" placeholder="Enter Dev Mentor">
                <input type="text" id="new-owners" placeholder="Enter Owners">
                <select id="new-alf-status">
                    <option value="Not Started">Not Started</option>
                    <option value="Completed">Already Covered in ALF</option>
                    <option value="On Hold">Not Covered by ALF</option>
                    <option value="Blocked">Not Applicable for ALF</option>
                    <option value="Cancelled">Retired/Deactivated</option>
                    <option value="Waiting for Resource">ALF Required/Response Received</option>
                    <option value="In Progress">In Progress</option>
                </select>
                <input type="text" id="new-repolinks" placeholder="Enter RepoLinks">
                <select id="new-analyst"></select>
                <textarea id="new-comments" placeholder="Enter Comments"></textarea>
                <button class="btn-save" onclick="createNewEngagement()">Create</button>
                <button class="btn-cancel" onclick="cancelNew()">Cancel</button>
            </div>
        </div>
        <div class="toast" id="toast"></div>
        <div class="loading" id="loading">
            <div class="spinner"></div>
        </div>
    </div>

    <script>
        const baseUrl = 'https://demo.defectdojo.org';
        const csrfUrl = 'https://demo.defectdojo.org/api/key-v2';
        let currentPage = 1;
        let totalPages = 1;
        let data = [];
        let filteredData = [];
        let users = [];
        let csrfToken = '';

        async function fetchCsrfToken() {
            try {
                showLoading();
                const response = await fetch(csrfUrl);
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                csrfToken = doc.querySelector('input[name="csrfmiddlewaretoken"]')?.value || '';
                if (!csrfToken) {
                    throw new Error('CSRF token not found in the page');
                }
            } catch (error) {
                console.error('Error fetching CSRF token:', error);
                showToast('Failed to fetch CSRF token. Please try again.', false);
            } finally {
                hideLoading();
            }
        }

        async function fetchUsers() {
            try {
                showLoading();
                const response = await fetch(`${baseUrl}/api/v2/users/`);
                const result = await response.json();
                users = result.results || [];
                populateAnalystFilter();
            } catch (error) {
                console.error('Error fetching users:', error);
                users = [];
                populateAnalystFilter();
            } finally {
                hideLoading();
            }
        }

        function populateAnalystFilter() {
            const analystFilter = document.getElementById('analyst-filter');
            const modalAnalyst = document.getElementById('modal-analyst');
            const newAnalyst = document.getElementById('new-analyst');
            analystFilter.innerHTML = '<option value="">Select Analyst</option>';
            modalAnalyst.innerHTML = '<option value="">Select Analyst</option>';
            newAnalyst.innerHTML = '<option value="">Select Analyst</option>';
            users.forEach(user => {
                const name = `${user.first_name || ''} ${user.last_name || ''}`.trim();
                if (name) {
                    analystFilter.innerHTML += `<option value="${user.id}">${name}</option>`;
                    modalAnalyst.innerHTML += `<option value="${user.id}">${name}</option>`;
                    newAnalyst.innerHTML += `<option value="${user.id}">${name}</option>`;
                }
            });
        }

        async function fetchData() {
            try {
                showLoading();
                await fetchCsrfToken();
                await fetchUsers();
                const response = await fetch(`${baseUrl}/api/v2/engagements/?offset=${(currentPage - 1) * 10}&limit=10`);
                const result = await response.json();
                data = result.results || [];
                totalPages = Math.ceil(result.count / 10) || 1;
                filteredData = [...data];
                populateFilters();
                renderTable();
                updatePagination();
            } catch (error) {
                console.error('Error fetching engagements:', error);
                data = [];
                filteredData = [];
                renderTable();
                updatePagination();
                showToast('Failed to load engagements. Please try again.', false);
            } finally {
                hideLoading();
            }
        }

        function populateFilters() {
            const versions = [...new Set(data.map(item => item.version).filter(v => v))];
            const products = [...new Set(data.map(item => item.name).filter(n => n))];
            const vps = [...new Set(data.map(item => item.reason).filter(r => r))];
            const devMentors = [...new Set(data.map(item => item.build_id).filter(b => b))];
            const owners = [...new Set(data.map(item => item.commit_hash).filter(c => c))];

            document.getElementById('version-filter').innerHTML = '<option value="">Select Version</option>' + 
                versions.map(v => `<option value="${v}">${v}</option>`).join('');
            document.getElementById('product-filter').innerHTML = '<option value="">Select Product</option>' + 
                products.map(p => `<option value="${p}">${p}</option>`).join('');
            document.getElementById('vp-filter').innerHTML = '<option value="">Select VP</option>' + 
                vps.map(v => `<option value="${v}">${v}</option>`).join('');
            document.getElementById('dev-mentor-filter').innerHTML = '<option value="">Select Dev Mentor</option>' + 
                devMentors.map(d => `<option value="${d}">${d}</option>`).join('');
            document.getElementById('owners-filter').innerHTML = '<option value="">Select Owners</option>' + 
                owners.map(o => `<option value="${o}">${o}</option>`).join('');
        }

        function renderTable() {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';
            filteredData.forEach(item => {
                const analyst = users.find(u => u.id === item.lead) || {};
                const row = `
                    <tr>
                        <td>${item.version || ''}</td>
                        <td>${item.name || ''}</td>
                        <td>${item.reason || ''}</td>
                        <td>${item.build_id || ''}</td>
                        <td>${item.commit_hash || ''}</td>
                        <td>${getAlfStatusLabel(item.status)}</td>
                        <td>${item.tracker || ''}</td>
                        <td>${item.branch_tag || ''}</td>
                        <td>${item.description || ''}</td>
                        <td>${(analyst.first_name || '')} ${(analyst.last_name || '')}</td>
                        <td><button class="action-btn" onclick="openEditModal(${item.id})">Edit</button></td>
                    </tr>`;
                tableBody.innerHTML += row;
            });
        }

        function getAlfStatusLabel(status) {
            const statusMap = {
                'Completed': 'Already Covered in ALF',
                'On Hold': 'Not Covered by ALF',
                'Blocked': 'Not Applicable for ALF',
                'Cancelled': 'Retired/Deactivated',
                'Waiting for Resource': 'ALF Required/Response Received',
                'Not Started': 'Not Started',
                'In Progress': 'In Progress'
            };
            return statusMap[status] || status || '';
        }

        function applyFilters() {
            const version = document.getElementById('version-filter').value;
            const product = document.getElementById('product-filter').value;
            const vp = document.getElementById('vp-filter').value;
            const devMentor = document.getElementById('dev-mentor-filter').value;
            const owners = document.getElementById('owners-filter').value;
            const alfStatus = document.getElementById('alf-status-filter').value;
            const repolinks = document.getElementById('repolinks-filter').value.toLowerCase();
            const comments = document.getElementById('comments-filter').value.toLowerCase();
            const analyst = document.getElementById('analyst-filter').value;

            filteredData = data.filter(item => {
                return (!version || item.version === version) &&
                    (!product || item.name === product) &&
                    (!vp || item.reason === vp) &&
                    (!devMentor || item.build_id === devMentor) &&
                    (!owners || item.commit_hash === owners) &&
                    (!alfStatus || item.status === alfStatus) &&
                    (!repolinks || (item.tracker && item.tracker.toLowerCase().includes(repolinks))) &&
                    (!comments || (item.description && item.description.toLowerCase().includes(comments))) &&
                    (!analyst || item.lead === parseInt(analyst));
            });
            currentPage = 1;
            renderTable();
            updatePagination();
        }

        function resetFilters() {
            document.getElementById('version-filter').value = '';
            document.getElementById('product-filter').value = '';
            document.getElementById('vp-filter').value = '';
            document.getElementById('dev-mentor-filter').value = '';
            document.getElementById('owners-filter').value = '';
            document.getElementById('alf-status-filter').value = '';
            document.getElementById('repolinks-filter').value = '';
            document.getElementById('comments-filter').value = '';
            document.getElementById('analyst-filter').value = '';
            filteredData = [...data];
            currentPage = 1;
            renderTable();
            updatePagination();
        }

        function updatePagination() {
            document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages;
        }

        function changePage(delta) {
            currentPage += delta;
            fetchData();
        }

        function showLoading() {
            document.getElementById('loading').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('show');
        }

        let currentEditId = null;

        function openEditModal(id) {
            currentEditId = id;
            const item = data.find(d => d.id === id);
            document.getElementById('modal-project').value = item.version || '';
            document.getElementById('modal-product').value = item.name || '';
            document.getElementById('modal-vp').value = item.reason || '';
            document.getElementById('modal-dev-mentor').value = item.build_id || '';
            document.getElementById('modal-owners').value = item.commit_hash || '';
            document.getElementById('modal-alf-status').value = item.status || '';
            document.getElementById('modal-repolinks').value = item.tracker || '';
            document.getElementById('modal-analyst').value = item.lead || '';
            document.getElementById('modal-comments').value = item.description || '';
            document.getElementById('edit-modal').classList.add('show');
        }

        function openNewModal() {
            document.getElementById('new-project').value = '';
            document.getElementById('new-product').value = '';
            document.getElementById('new-vp').value = '';
            document.getElementById('new-dev-mentor').value = '';
            document.getElementById('new-owners').value = '';
            document.getElementById('new-alf-status').value = 'Not Started';
            document.getElementById('new-repolinks').value = '';
            document.getElementById('new-analyst').value = '';
            document.getElementById('new-comments').value = '';
            document.getElementById('new-modal').classList.add('show');
        }

        async function saveChanges() {
            if (!csrfToken) {
                showToast('CSRF token is missing. Please refresh and try again.', false);
                return;
            }
            try {
                showLoading();
                const item = {
                    tags: ['ALF'], // Ensure tags include ALF
                    name: document.getElementById('modal-product').value,
                    target_start: new Date().toISOString().split('T')[0],
                    target_end: new Date().toISOString().split('T')[0],
                    status: document.getElementById('modal-alf-status').value || 'Not Started',
                    lead: parseInt(document.getElementById('modal-analyst').value) || null,
                    product: 1, // Adjust based on actual product ID
                    reason: document.getElementById('modal-vp').value || '',
                    build_id: document.getElementById('modal-dev-mentor').value || '',
                    commit_hash: document.getElementById('modal-owners').value || '',
                    tracker: document.getElementById('modal-repolinks').value || '',
                    description: document.getElementById('modal-comments').value || ''
                };

                const response = await fetch(`${baseUrl}/api/v2/engagements/${currentEditId}/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(item)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                document.getElementById('edit-modal').classList.remove('show');
                showToast('Changes saved successfully!');
                fetchData();
            } catch (error) {
                console.error('Error saving changes:', error);
                showToast('Failed to save changes. Please try again.', false);
            } finally {
                hideLoading();
            }
        }

        async function createNewEngagement() {
            if (!csrfToken) {
                showToast('CSRF token is missing. Please refresh and try again.', false);
                return;
            }
            try {
                showLoading();
                const productName = document.getElementById('new-product').value;
                if (!productName) {
                    showToast('Product name is required.', false);
                    return;
                }
                const item = {
                    tags: ['ALF'],
                    name: productName,
                    target_start: new Date().toISOString().split('T')[0],
                    target_end: new Date().toISOString().split('T')[0],
                    status: document.getElementById('new-alf-status').value || 'Not Started',
                    lead: parseInt(document.getElementById('new-analyst').value) || null,
                    product: 1, // Adjust based on actual product ID
                    version: document.getElementById('new-project').value || '',
                    reason: document.getElementById('new-vp').value || '',
                    build_id: document.getElementById('new-dev-mentor').value || '',
                    commit_hash: document.getElementById('new-owners').value || '',
                    tracker: document.getElementById('new-repolinks').value || '',
                    description: document.getElementById('new-comments').value || ''
                };

                const response = await fetch(`${baseUrl}/api/v2/engagements/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(item)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                document.getElementById('new-modal').classList.remove('show');
                showToast('Engagement created successfully!');
                fetchData();
            } catch (error) {
                console.error('Error creating engagement:', error);
                showToast('Failed to create engagement. Please try again.', false);
            } finally {
                hideLoading();
            }
        }

        function cancelEdit() {
            if (confirm('Do you want to close this without saving?')) {
                document.getElementById('edit-modal').classList.remove('show');
            }
        }

        function cancelNew() {
            if (confirm('Do you want to close this without creating?')) {
                document.getElementById('new-modal').classList.remove('show');
            }
        }

        function showToast(message, success = true) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.background = success ? '#4caf50' : '#f44336';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Initial fetch
        fetchData();
    </script>
</body>
</html>