import requests

# Configuration
base_url = "https://demo.defectdojo.org/api/v2/"
token = "jsjsjdjdhd"
headers = {
    "Authorization": f"Token {token}",
    "Content-Type": "application/json"
}

# Arrays to track tests
on_hold_tests = []
pending_tests = []

# Fetch all tests with tag "mcr_jira" excluding Completed and Rejected, handling pagination
tests = []
url = base_url + "tests/?tags=mcr_jira&branch_tag__nin=Completed,Rejected"
while url:
    response = requests.get(url, headers=headers)
    if response.status_code != 200:
        print(f"Failed to fetch tests: {response.status_code} {response.text}")
        exit(1)
    data = response.json()
    tests.extend(data['results'])
    url = data['next']

print(f"Total tests fetched (excluding Completed/Rejected): {len(tests)}")

# Define the statuses for Pending
pending_statuses = ["Ready for Testing", "Done", "Ready for QA", "Ready for PA"]

# Process each test
for test in tests:
    test_id = test['id']
    build_id = test.get('build_id', '')
    branch_tag = test.get('branch_tag', '')

    # Determine new branch_tag
    new_branch_tag = "Pending" if build_id in pending_statuses else "On Hold"

    # Skip if no update is needed
    if branch_tag == new_branch_tag:
        print(f"No update needed for test {test_id}: branch_tag already {new_branch_tag}")
        if new_branch_tag == "Pending":
            pending_tests.append(test_id)
        else:
            on_hold_tests.append(test_id)
        continue

    # Update the test
    update_url = base_url + f"tests/{test_id}/"
    payload = {"branch_tag": new_branch_tag}
    response = requests.patch(update_url, headers=headers, json=payload)
    if response.status_code == 200:
        print(f"Updated test {test_id}: branch_tag set to {new_branch_tag}")
        if new_branch_tag == "Pending":
            pending_tests.append(test_id)
        else:
            on_hold_tests.append(test_id)
    else:
        print(f"Failed to update test {test_id}: {response.status_code} {response.text}")

# Display summary
print(f"\nSummary:")
print(f"Tests marked as On Hold: {len(on_hold_tests)} {on_hold_tests}")
print(f"Tests marked as Pending: {len(pending_tests)} {pending_tests}")