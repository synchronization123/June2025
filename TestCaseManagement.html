import requests

# Configuration
base_url = "https://demo.defectdojo.org/api/v2/"
token = "jsjsjdjdhd"
headers = {
    "Authorization": f"Token {token}",
    "Content-Type": "application/json"
}

# Fetch all tests with tag "mcr_jira" handling pagination
tests = []
url = base_url + "tests/?tags=mcr_jira"
while url:
    response = requests.get(url, headers=headers)
    if response.status_code != 200:
        print(f"Failed to fetch tests: {response.status_code} {response.text}")
        exit(1)
    data = response.json()
    tests.extend(data['results'])
    url = data['next']

print(f"Total tests fetched: {len(tests)}")

# Define the statuses for Pending
pending_statuses = ["Ready for Testing", "Done", "Ready for QA", "Ready for PA"]

# Process each test
for test in tests:
    test_id = test['id']
    build_id = test.get('build_id', '')
    branch_tag = test.get('branch_tag', '')

    if branch_tag in ["Completed", "Rejected"]:
        print(f"Skipping test {test_id}: branch_tag is {branch_tag}")
        continue

    if build_id in pending_statuses:
        new_branch_tag = "Pending"
    else:
        new_branch_tag = "On Hold"

    if branch_tag == new_branch_tag:
        print(f"No update needed for test {test_id}: branch_tag already {new_branch_tag}")
        continue

    # Update the test
    update_url = base_url + f"tests/{test_id}/"
    payload = {"branch_tag": new_branch_tag}
    response = requests.patch(update_url, headers=headers, json=payload)
    if response.status_code == 200:
        print(f"Updated test {test_id}: branch_tag set to {new_branch_tag}")
    else:
        print(f"Failed to update test {test_id}: {response.status_code} {response.text}")